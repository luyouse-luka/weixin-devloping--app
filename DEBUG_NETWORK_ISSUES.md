# 网络请求问题排查指南

## 问题现象

浏览器可以正常访问 `https://luyouseapp.top/api/products/orderCounts`，但小程序中报错 `ERR_CONNECTION_CLOSED`。

## 可能原因及解决方案

### 1. 域名白名单未配置（最常见）

**问题：** 微信小程序要求所有网络请求的域名必须在后台配置白名单。

**解决方案：**

#### 方法A：配置域名白名单（正式环境必须）

1. 登录微信公众平台：https://mp.weixin.qq.com
2. 进入：**开发** -> **开发管理** -> **开发设置**
3. 找到 **服务器域名** -> **request合法域名**
4. 点击 **修改**，添加域名：
   ```
   https://luyouseapp.top
   ```
5. 点击 **保存**
6. 等待 5-10 分钟生效
7. 重新编译小程序

#### 方法B：开发环境临时方案（仅用于开发调试）

在微信开发者工具中：
1. 点击右上角 **详情**
2. 在 **本地设置** 标签页
3. 勾选 **不校验合法域名、web-view、TLS版本以及HTTPS证书**
4. 重新编译

⚠️ **注意：** 此选项仅用于开发环境，正式版本必须配置域名白名单。

### 2. 网络环境问题

**检查项：**
- 确认网络连接正常
- 检查是否有代理或防火墙阻止
- 尝试切换网络（WiFi/移动网络）

### 3. 服务器CORS配置

虽然浏览器可以访问，但小程序请求可能需要额外的CORS配置。

**检查服务器代码：** `server-api/server.js`

确保已启用CORS：
```javascript
app.use(cors());
```

### 4. 微信开发者工具设置

**检查：**
1. 微信开发者工具版本是否最新
2. 项目设置中的网络相关配置
3. 是否有其他网络拦截工具

### 5. 调试步骤

#### 步骤1：查看控制台日志

代码已添加详细日志，查看控制台输出：
- `[API请求]` - 请求开始
- `[API成功]` - 请求成功
- `[API失败]` - 请求失败及详细错误信息

#### 步骤2：检查错误类型

根据控制台日志中的 `errorType` 判断：
- `domain_whitelist` - 域名白名单问题
- `timeout` - 请求超时
- `network` - 网络连接问题

#### 步骤3：测试API

在浏览器中测试：
```bash
curl https://luyouseapp.top/api/products/orderCounts
```

应该返回：
```json
{"success": true, "data": {}}
```

## 快速解决方案（开发环境）

如果急需测试，可以临时使用：

1. **微信开发者工具** -> **详情** -> **本地设置**
2. 勾选 **不校验合法域名、web-view、TLS版本以及HTTPS证书**
3. 重新编译

这样可以在开发环境中跳过域名校验。

## 正式环境要求

⚠️ **重要：** 正式版本必须：
1. 在微信小程序后台配置域名白名单
2. 取消勾选"不校验合法域名"选项
3. 确保服务器正常运行

## 验证配置

配置完成后，检查控制台：
- 应该看到 `[API成功]` 日志
- 不再出现 `ERR_CONNECTION_CLOSED` 错误
- 数据正常加载

