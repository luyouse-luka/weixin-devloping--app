# 微信小程序域名白名单配置指南

## 问题说明

如果遇到 `ERR_CONNECTION_CLOSED` 或 `不在以下 request 合法域名列表中` 错误，说明需要在微信小程序后台配置域名白名单。

## 配置步骤

### 1. 登录微信公众平台

1. 访问：https://mp.weixin.qq.com
2. 使用小程序管理员账号登录

### 2. 进入开发管理

1. 在左侧菜单找到 **开发** -> **开发管理**
2. 点击 **开发设置**

### 3. 配置服务器域名

在 **服务器域名** 部分，找到 **request合法域名**：

#### 需要添加的域名：
```
https://luyouseapp.top
```

#### 配置步骤：
1. 点击 **修改** 按钮
2. 在 **request合法域名** 输入框中添加：
   ```
   https://luyouseapp.top
   ```
3. 点击 **保存**

### 4. 注意事项

⚠️ **重要提示：**
- 域名必须使用 **HTTPS** 协议
- 域名必须已备案（如果使用国内服务器）
- 域名必须支持 SSL 证书
- 配置后需要等待 **5-10分钟** 生效
- 开发版本需要重新编译才能生效

### 5. 验证配置

配置完成后：
1. 在微信开发者工具中重新编译小程序
2. 查看控制台，确认不再出现域名错误
3. 测试 API 请求是否正常

## 常见错误及解决方案

### 错误1：`ERR_CONNECTION_CLOSED`
**原因：** 域名未配置或服务器未启动
**解决：**
- 检查域名是否已添加到白名单
- 检查服务器是否正常运行
- 检查服务器防火墙是否开放端口

### 错误2：`不在以下 request 合法域名列表中`
**原因：** 域名未添加到白名单
**解决：** 按照上述步骤添加域名

### 错误3：`SSL证书错误`
**原因：** 服务器 SSL 证书配置问题
**解决：**
- 检查服务器 SSL 证书是否有效
- 确保证书域名匹配
- 检查证书是否过期

### 错误4：`请求超时`
**原因：** 网络问题或服务器响应慢
**解决：**
- 检查网络连接
- 检查服务器是否正常运行
- 检查服务器日志

## 测试 API 连接

可以使用以下命令测试 API 是否可访问：

```bash
# 测试获取商品订单次数
curl https://luyouseapp.top/api/products/orderCounts

# 应该返回 JSON 格式数据
```

## 服务器配置检查清单

- [ ] 服务器已启动并运行
- [ ] 服务器监听端口正确（通常是 443 或 80）
- [ ] SSL 证书已配置且有效
- [ ] 域名 DNS 解析正确
- [ ] 防火墙规则允许访问
- [ ] 微信小程序后台已添加域名白名单
- [ ] 小程序已重新编译

## 联系支持

如果配置后仍有问题，请检查：
1. 服务器日志：`server-api/server.js` 运行日志
2. 微信开发者工具控制台错误信息
3. 网络连接状态

